\chapter{Programmazione del servizio online parte 2}\label{cap:Programmazione del servizio online parte 2}

\section{Creazione del sito internet}\label{sez:Creazione sito internet}

La creazione del dito internet si può suddividere nella creazione delle singole pagine che lo compongo.

\subsection{Creazione pagina di registrazione e di accesso}
L'intera produzione del sito internet è stata fatta seguendo la filosofia di dare più importanza ai lavori "più grossi", facendosi che quindi il progetto si sia sviluppo a partire da un nucleo principale per poi espandersi, al contrario di  come comunemente vengono condotti questo genere di progetti, partendo dalle specifiche più esterne (in modo da avere più velocemente una idea del prodotto finito) per poi convergere verso il nucleo.\\
Secondo la specifica del progetto, il sito deve essere in grado di essere accessibile solo agli utenti registrati (verificando inoltre che la mail che abbiano inserito sia reale), garantendo inoltre la sicurezza, ossia che il sito deve possedere le principali difese per non essere attaccato e che in caso di attacco i dati degli utenti siano all'interno del "database" cifrati in modo da non poter essere utilizzati da terzi.\\
La prima pagina che è stata creata in assoluto è quella di accesso, dalla quale poi premendo un  pulsante è possibile accedere alla pagina di registrazione. Com'è deducibile queste due pagine sono state in contemporanea siccome la prima permette di verificare li corretto funzionamento della seconda.\\

Dopo aver studiato velocemente "l'html" e il "php" (il "javascript" è stato lasciato in secondo piano) decido di sviluppare il codice ("php") con paradigma ad oggetti, siccome mi è molto famigliare. Ragionando solo a livello di logica decido di creare una classe "utilities" nella quale poter scrivere i metodi che poi mi torneranno utili durante anche lo sviluppo delle restanti parti.\\

Si esplicita in questa sede che le varie classi che saranno presentate sono state divise ed ordinate in cartelle sulla base delle loro funzionalità.\\

\paragraph{Classe utilities}
La classe "utilities" (quindi il relativo file) è stata implementata in questo modo:\\
Per prima si è deciso di dividere in file separati i metodi e le chiavi per il loro funzionamento. Questa cosa è stata fatta prevalentemente per ragioni di ordine del codice e per aumentare la sicurezza.\\
Il primo metodo presente è quello che permette di creare l'oggetto "mysqli" che serve per poter interagire con il database (da notare come nella porzione di codice inferiore non vi siano riportati direttamente i dati di accesso). Essendo evidente che questo oggetto è per sua stessa statico, durante l'implementazione del metodo si è usato il "singleton pattern" per evitare che in memoria vi siano multipli oggetti identici.\\

\begin{lstlisting}[language=php]
	/*using singleton pattern*/
	public function getMysql(){
		if($this->mysqli == null){
			$this->mysqli = new mysqli(SERVER, USER, PASSWORD, DATABASE);
			
		}
		return $this->mysqli;
	}
\end{lstlisting}

In questa classe sono stati scritti i metodi per cifrare e decifrare le stringe da salvare poi nella tabella degli utenti all'interno del database.\\

\begin{lstlisting}[language=php]
/*Function to crypt a string*/
public function Encrypt($string){
	$encrypt_method = "AES-256-CBC";
	$key = hash( 'sha256', $secret_key );
	$iv = substr( hash( 'sha256', $secret_iv ), 0, 16 );
	$output = base64_encode( openssl_encrypt( $string, $encrypt_method, $key, 0, $iv ) );
	return $output;
}


/*Function to decrypt a string*/
public function Decrypt($string){
	$encrypt_method = "AES-256-CBC";
	$key = hash( 'sha256', $secret_key );
	$iv = substr( hash( 'sha256', $secret_iv ), 0, 16 );
	$output = openssl_decrypt( base64_decode( $string ), $encrypt_method, $key, 0, $iv );
	return $output;
}
\end{lstlisting}

Sempre in questa classe è stato scritto il metodo che si occupa di inviare agli utenti la mail con il link per poter effettuare la verifica della mail di registrazione.\\
Per la costruzione del metodo sono state usate le classi messe a disposizione da "\href{https://github.com/PHPMailer/PHPMailer}{PHPMailer}"

\begin{lstlisting}[language=php]
public function SendEmail($address, $subject, $body, $altBody){
	
	$mail = new PHPMailer(true);
	
	try{
		//server settings
		$mail->SMTPDebug = 0; //SMPT::DEBUG_OFF;
		$mail->isSMTP();
		$mail->Host       = 'smtp.gmail.com';
		$mail->SMTPAuth   = true;
		$mail->Username   = 'quiz.patenti.nautiche@gmail.com';
		$mail->Password   = MAIL_PASSWORD;
		$mail->SMTPSecure = PHPMailer::ENCRYPTION_SMTPS;
		$mail->Port       = 465;
		
		//Recipients
		$mail->setFrom('quiz.patenti.nautiche@gmail.com', 'Quiz Patenti Nautiche');
		$mail->addAddress($address);
		
		//Content
		$mail->isHTML(true);
		$mail->Subject = $subject;
		$mail->Body = $body;
		$mail->AltBody = $altBody;
		
		//Send
		$mail->send();
		
		echo "Message has been sent";
	}catch (Exception $e){
		echo "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
	}
}
\end{lstlisting}

\subparagraph{Approfondimento gestione della verifica della mail di registrazione}
A questo punto si desidera aprire una breve parentesi per approfondire la gestione della verifica della mail.\\
Dalla classe "Utilities" è possibile usare il metodo che permette l'invio della mail di verifica, ma ovviamente questo metodo prevede degli argomenti in ingresso che adesso saranno esplicitati in ordine: Il primo è l'indirizzo mail del destinatario, che è prelevabile dal database; l'oggetto della mail e i restanti argomenti sono stati definiti all'interno di un'altra classe chiamata "MailUtilities".\\
Come prima cosa è stato definito un "link base di rientro" che se cliccato dalla mail permette di ritornare alla pagina della applicazione web.\\

 \begin{lstlisting}[language=php]
	const URL = "https://quizpatentinautiche.dynamic-dns.net:8080/";
 \end{lstlisting}
 
  Successivamente è stato stabilito un metodo con il quale poter reperire l'oggetto della mail, del quale si è preferito scriverlo in questa sede per tenere raggruppati i vari argomenti necessari per l'invio della mail in un unico posto.\\
 
\begin{lstlisting}[language=php]
public function getSubject(){
	return "Verifica della mail.";
}
\end{lstlisting}

Di seguito è stato definito il corpo "html" della mail, il quale per un qualche motivo poco chiaro non viene visualizzato correttamente su alcuni gestori di servizi mail. \\

\begin{lstlisting}[language=php]
public function getBody($linkToUse){
	return '<html>
	<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	</head>
	<body style="background-color: #e9ecef;">
	<div class="login-form" style="background: #fff;
	width: 500px; margin: 65px auto; display: -webkit-box;
	display: flex; flex-direction: column; border-radius: 4px;
	box-shadow: 0 2px 25px rgba(0, 0, 0, 0.2);">
	<form method="post">
	<h1 style="padding: 35px 35px 0 35px; font-weight: 300;
	font-family: "Rubik", sans-serif; text-align: center;">
	Verifica la tua mail
	</h1>
	<div style="margin: 25px auto; padding: 18px;
	font-family: "Rubik", sans-serif; text-align: center;">
	Clicca su questo pulsante per accedere alla pagina di verifica della mail inserita su:
	<a href='.self::URL.'>Quiz Patenti Nautiche</a>
	</div>
	<div>
	<a href='.$linkToUse.'>
	<button style="width: 250px; height: 50px; border: none;
	border-radius: 4px; padding: 18px; font-family: "Rubik", sans-serif;
	font-size: large; cursor: pointer; background: #2d3b55; color: #fff;
	letter-spacing: 0.2px; outline: 0; position: relative; top: 50\%;
	left: 50\%; -ms-transform: translate(-50\%, -50\%); transform: translate(-50\%, -50\%);">
	Verifica la tua Mail
	</button>
	</a>
	</div>
	</form>
	</div>
	</body>	</html>';
}
 \end{lstlisting}
 
 Ultima è stata la definizione del corpo alternativo nel caso in cui non si voglia visualizzare la mail con il corpo "html".\\
 
  \begin{lstlisting}[language=php]
 public function getAlternativeBody($linkToUse){
 	return 'Usa questo link per accedere alla pagina di verifica della mail: '.$linkToUse;
 }
  \end{lstlisting}
  
  Sono stati inoltre scritti dei metodi aggiuntivi per facilitare l'interazione con "l'url" da usare per verificare la mail:\\
  
 \begin{lstlisting}[language=php]
   	public function getUrl($myData){
   		return self::URL."?".http_build_query($myData);
   	}
   	
   	public function getInfoFromUrl($url){
   		$url_component = parse_url($url);
   		parse_str($url_component['query'], $params);
   		return $params;
   	}
 \end{lstlisting}
 
 Per spiegare correttamente il funzionamento della logica viene riportato inferiormente la parte di codice della pagina di registrazione che sfrutta i metodi presentati sopra per mandare la mail di verifica dopo la registrazione. 
 
 \begin{lstlisting}[language=php]
 $mailUtil = new MailUtilities();
 
 $tempArray = array("email" => $email);
 
 $URLToSend = $mailUtil->getURL($tempArray);
 
 $utilities->SendEmail($_POST['email'], $mailUtil->getSubject(), $mailUtil->getBody($URLToSend), $mailUtil->getAlternativeBody($URLToSend));
 /*--- Return to main page ---*/
 $_SESSION['user'] = "Registrated";
 header("Location: main.php");
 exit;
  \end{lstlisting}
  
  In pratica (dopo aver controllato la consistenza dei dati nel database) come si può facilmente leggere, la mail di destinazione viene presa direttamente dal campo di testo della pagina, l'oggetto della mail da inviare è semplicemente prelevato, mentre "l'url" che verrà usato nel corpo della mail (generato usando il metodo "getUrl") sarà l'unione del link base per poter accedere al sito con in più (come argomento) la mail cifrata dell'utente stesso da usare per fare poi l'accesso al database dalla pagina di verifica della mail del sito.\\
  In particolare (come poi mostrato dal codice riportato inferiormente) per favorire questo processo, la prima pagina in assoluto che viene caricata quando si fa l'accesso alla "web app" non è la pagina di accesso, ma bensì una pagina che a seconda se nell'"url" con il quale si fa l'acceso al sito è presente un argomento o meno, fa poi un "redirect" alla pagina apposita.\\
  
 \begin{lstlisting}[language=php]
 <?php
 require 'Quiz-Patente-Nautica/Pagina_Web/ValidationMail/mailUtilities.php';
 
 session_start();
 
 $urlUtility = new MailUtilities();
 $array = $urlUtility->getInfoFromUrl($_SERVER['REQUEST_URI']);
 
 if( $array['email']!== null){	
 	
 	$_SESSION['email'] = $array['email'];
 	header("location:Quiz-Patente-Nautica/Pagina_Web/ValidationMail/verificationMail.php");
 	exit;
 }else{
 	header("Location:Quiz-Patente-Nautica/Pagina_Web/main.php");
 	exit;
 }
 ?>
 \end{lstlisting}
 
 Nel caso in cui nell'"url" ci sia un argomento, ecco il comportamento della pagina di verifica della mail.\\
 
 \begin{lstlisting}[language=php]
 /*verify if the mail verifiy is not happened for the account*/
 
 $query = $utilities->getMysql()->query("SELECT verified FROM user_table1 WHERE (email = '{$_SESSION['email']}')");
 $tempArray = $query->fetch_array(MYSQLI_ASSOC);
 
 //redirect in positive case
 
 if($tempArray['verified'] == true){
 	$_SESSION['user'] = "Verified";
 	$_SESSION['email'] = null;
 	header("location:../main.php");
 	exit;
 	
 }
 
 $query = $utilities->getMysql()->query("SELECT id FROM user_table1 WHERE (email = '{$_SESSION['email']}')");
 $tempArray = $query->fetch_array(MYSQLI_ASSOC);
 
 /*verify if the mail is correct*/
 if($tempArray['id'] == null){
 	$_SESSION['user'] = "NoMail";
 	header("location:../main.php");
 	exit;
 }
 
 /*now wait for confirm the mail*/
 
 if(isset($_POST['confirm'])){
 	
 	$temp = $utilities->getMysql()->query("UPDATE user_table1 SET verified = 1 WHERE (id = '{$tempArray['id']}')");
 	
 	if(!$temp){
 		$_SESSION['user'] = "DatabaseError";
 		$_SESSION['email'] = null;
 		header("location:../main.php");
 		exit;
 	}
 	
 	$query = $utilities->getMysql()->query("SELECT verified FROM user_table1 WHERE (email = '{$_SESSION['email']}')");
 	$tempArray = $query->fetch_array(MYSQLI_ASSOC);
 	
 	if($tempArray['verified'] == true){
 		$_SESSION['user'] = "YesMail";
 		$_SESSION['email'] = null;
 		header("location:../main.php");
 		exit;
 		
 	}else{
 		$_SESSION['user'] = "DatabaseError";
 		$_SESSION['email'] = null;
 		header("location:../main.php");
 		exit;
 	}
 }
 \end{lstlisting}
 
 Come si può facilmente notare, prima di tutto viene verificato che l'operazione di verifica non sia già avvenuta, successivamente si aspetta poi che l'utente premi il pulsante di verifica per poter poi scrivere nel database l'avvenuta verifica.\\